#!/usr/bin/expect -f
# Full interactive REPL testing

set timeout 60
log_user 1

puts "\n╔═══════════════════════════════════════════════════╗"
puts "║  ROZET INTERACTIVE REPL TESTING                   ║"
puts "╚═══════════════════════════════════════════════════╝\n"

puts "=== TEST 1: Basic REPL Startup ==="
set start_time [clock seconds]
spawn rozett --repl

# Wait for the "You:" prompt
expect {
    -re "You:" {
        set elapsed [expr [clock seconds] - $start_time]
        puts "\n✅ REPL started successfully in ${elapsed}s"
        puts "✅ Prompt appeared: 'You:'"
    }
    -re "Error|Exception|Traceback" {
        puts "\n❌ Error on startup: $expect_out(0,string)"
        exit 1
    }
    timeout {
        puts "\n❌ Timeout - REPL didn't start within 60 seconds"
        exit 1
    }
    eof {
        puts "\n❌ REPL exited immediately"
        exit 1
    }
}

puts "\n=== TEST 2: Greeting Interaction ==="
puts "Typing: hello"
set start_time [clock seconds]
send "hello\r"

expect {
    -re "You:" {
        set elapsed [expr [clock seconds] - $start_time]
        puts "\n✅ Response received in ${elapsed}s"
        puts "✅ Returned to prompt"
    }
    -re "Error|Exception|Traceback" {
        puts "\n❌ Error on greeting: $expect_out(buffer)"
    }
    timeout {
        puts "\n⚠️  Response took longer than 60 seconds"
    }
}

puts "\n=== TEST 3: Help Command ==="
puts "Typing: help"
send "help\r"

expect {
    -re "You:" {
        puts "\n✅ Help command completed"
    }
    timeout {
        puts "\n⚠️  Help command timed out"
    }
}

puts "\n=== TEST 4: Empty Input ==="
puts "Typing: (empty, just Enter)"
send "\r"

expect {
    -re "You:" {
        puts "\n✅ Empty input handled gracefully"
    }
    timeout {
        puts "\n⚠️  Hung on empty input"
    }
}

puts "\n=== TEST 5: Simple Task ==="
puts "Typing: create a file test.txt with hello world"
send "create a file test.txt with hello world\r"

expect {
    -re "You:" {
        puts "\n✅ Simple task completed"
    }
    timeout {
        puts "\n⚠️  Task took longer than 60 seconds"
    }
}

puts "\n=== TEST 6: Exit Command ==="
puts "Typing: exit"
send "exit\r"

expect {
    eof {
        puts "\n✅ REPL exited cleanly"
    }
    timeout {
        puts "\n❌ Exit command didn't work"
    }
}

puts "\n╔═══════════════════════════════════════════════════╗"
puts "║  TEST COMPLETE                                     ║"
puts "╚═══════════════════════════════════════════════════╝\n"
